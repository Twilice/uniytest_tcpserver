<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Prototype - %UNITY_WEB_NAME%</title>
  <script src="%UNITY_WEBGL_LOADER_URL%"></script>
  <script>
    var unityInstance;
    const utf8encoder = new TextEncoder();
    const utf8decoder = new TextDecoder("utf-8");
    var websocket;

    function NetworkGameMessage(service, operation, data) {
        this.serviceName = service;
        this.operationName = operation;
        this.datamembers = data;
    }

    function ChatMessage(usr, msg) {
        this.timestamp = new Date().toISOString();
        this.user = usr;
        this.message = msg;
    }

    function Init() {
      unityInstance = UnityLoader.instantiate(document.getElementById("autogenerated-unity-container"), "%UNITY_WEBGL_BUILD_URL%", {
        onProgress: LoadingBar,
        Module: {
          onRuntimeInitialized: RuntimeInitialized
        }
      });
      // UnityLoader overwrites+resets the elements style... so reapply border...
      unityInstance.container.style.border = "2px solid aqua";
      unityInstance.container.style.borderRadius = "5px";
    }

    gameobject = "webglgameclient";
    onConnectUnity = "ServerConnected";
    onRecieveNetworkMessage = "RecieveNetworkGameMessage";
    function RegisterCallBack(gameobjectName, onConnectUnityCallback, onRecieveNetworkMessageCallback) {
      gameobject = gameobjectName;
      onConnectUnity = onConnectUnityCallback;
      onRecieveNetworkMessage = onRecieveNetworkMessageCallback;
    }

    var https = false; // todo : add way to change, we do via console for now.
    function Connect(ipadress, port, username) {
    //function Connect() {
      console.log("try connect");

      // temp :: try hardcode for now, we have very strange null error.
      // https = false;
      // ipadress = "127.0.0.1";
      // username = "webglunityuser";
      // gameobjectName = "webglgameclient";
      // onConnectUnityCallback = "ServerConnected";
      // onRecieveNetworkMessageCallback = "RecieveNetworkGameMessage";

      // todo :: how to wss (https), ws probably only works because local.
      if (https) {
        websocket = new WebSocket("wss://" + ipadress + ":" + port + "/");
      }
      else {
        websocket = new WebSocket("ws://" + ipadress + ":" + port + "/");
      }

      websocket.onopen = function (e) {
        console.log("connected to " + ipadress + port);
        SendMessageToUnity(gameobject, onConnectUnity);
      }

    
      websocket.onmessage = function (event) {
        console.log(event.data);

        let blob = event.data;
        blob.text().then(text => {
          var networkGameMessage = JSON.parse(text);
          //SendMessageToUnity(gameobject, onRecieveNetworkMessage, JSON.stringify(utf8encoder.encode(networkGameMessage))) // todo :: I'm tired, I can probably just send in the blobc
          SendMessageToUnity(gameobject, onRecieveNetworkMessage, JSON.stringify(networkGameMessage)) // todo :: I'm tired x2 of parsing issues, just send the string...
        });
      }
    }

    function SendMessageToUnity(gameobjectName, functionName, param) {
      if (param) {
        unityInstance.SendMessage(gameobjectName, functionName, param);
      }
      else {
        unityInstance.SendMessage(gameobjectName, functionName);
      }
    }

    function MessageReceivedFromUnity(message) {
      console.log(message);
    }

    // and I would have gotten away with it if it weren't for you meddling parse issues!
    //function PipeGameMessageToServer(utf8bytes) { 
      function PipeGameMessageToServer(jsonString) { 
      //console.log(utf8bytes);
      //console.log(JSON.parse(utf8decoder.decode(utf8bytes)));
      console.log(jsonString);
      console.log(JSON.parse(jsonString));
      websocket.send(utf8encoder.encode(jsonString));
    }

    function SendNetworkMessage(obj) {
      if (!websocket) {
          alert("no websocket connection :'(");
      }
      let jsonstring = JSON.stringify(obj);
      websocket.send(utf8encoder.encode(jsonstring));
    }


    function Userchatmessage(user, text) {
      let chatMessage = JSON.stringify(new ChatMessage(user, text));
      let networkGameMessage = new NetworkGameMessage("chat", "message", [chatMessage]);
      SendNetworkMessage(networkGameMessage);
    }


    function GameInitialized() {
      console.log("Unity Game Initialized")
      unityInstance.progress.style.right = "0%";
      unityInstance.progress.style.backgroundColor = "rgb(0, 80, 255)";
    }

    function RuntimeInitialized() {
      unityInstance.progress.style.right = "10%";
      unityInstance.progress.style.backgroundColor = "rgb(25, 80, 230)";
    }

    function LoadingBar(unityInstance, progress) {
      if (!unityInstance.Module) {
        return;
      }
      if(!unityInstance.progress) {
        unityInstance.progress = document.createElement("div");
        unityInstance.progress.setAttribute("id", "loading-bar");
        unityInstance.container.appendChild(unityInstance.progress);
      }
      if(progress <= 0.9) {
        unityInstance.progress.style.right = (100 * (1-progress*3/4)) + '%';
        unityInstance.progress.style.backgroundColor = `rgb(${255 * (1 - progress*3/4)}, 80, ${255 * progress*3/4})`;
      }
      if(progress == 1) {
        setTimeout(() => { unityInstance.progress.style.transition = "1s ease-in"; unityInstance.progress.style.opacity = 0; }, 1000);
        setTimeout(() => unityInstance.progress.style.display = "none", 2000);
      }
    }

  </script>
  <style>
     body {
      background-color: teal;
      color: turquoise;
    }

    #game-area {
      position: fixed;
      top: 5%;
      right: 0;
      bottom: 10%;
      left: 0;
      margin: auto;
      width: %UNITY_WIDTH%px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
  
    #autogenerated-unity-container {
      width: %UNITY_WIDTH%px;
      height: %UNITY_HEIGHT%px;
      flex-shrink: 0;
      border: 2px solid aqua;
      border-radius: 5px;
    }

    #loading-bar {
      position: absolute;
      left: 0;
      right: 100%;
      top: 40%;
      bottom: 40%;
      background-color: rgb(255,80,0);
      transition: 0.5s linear;
    }
  
    #restart-button {
      margin-left: 0;
      margin-right: auto;
      background-color: rgb(50,50,60);
      text-align: center;
      display: inline-block;
      border-radius: 5px;
      padding: 1px 4px;
      cursor: default;
      color: #dfdfdf;
    }
  </style>
</head>
<body onload="Init()">
  <div id="game-area" onclick="">
    <h1>Prototype - %UNITY_WEB_NAME%</h1>
    <div id="autogenerated-unity-container"></div>
  </div>
</body>
</html>